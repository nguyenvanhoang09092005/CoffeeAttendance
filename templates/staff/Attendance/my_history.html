{% extends 'staff/Dashboard/base.html' %}
{% load static %}
{% block body %}
   
<div class="page-wrapper">
  <div class="content container-fluid">

    <!-- Header -->
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="page-title">L·ªãch s·ª≠ ch·∫•m c√¥ng c·ªßa t√¥i</h3>
          <ul class="breadcrumb">
            {% comment %} <li class="breadcrumb-item">
              <a href="{% url 'home' %}">Trang ch·ªß</a>
            </li> {% endcomment %}
            <li class="breadcrumb-item active">L·ªãch s·ª≠ ch·∫•m c√¥ng</li>
          </ul>
        </div>
        {% comment %} <div class="col-auto">
          <a href="{% url 'attendance:toggle' %}" class="btn btn-primary">
            <i class="fas fa-clock"></i> Ch·∫•m c√¥ng ngay
          </a>
        </div> {% endcomment %}
      </div>
    </div>

    <!-- Th√¥ng tin nh√¢n vi√™n -->
   <div class="card mb-3 shadow-sm border-0 rounded-3">
  <div class="card-body ">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h5 class="mb-1">üë§ {{ employee.first_name }} {{ employee.last_name }}</h5>
        <p class="text-muted mb-0">
          M√£ NV: <strong>{{ employee.employee_id }}</strong>
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <p class="mb-1">
          <strong>Ch·ª©c v·ª•:</strong>
          <span class="badge bg-info">{{ employee.get_position_display|default:"Nh√¢n vi√™n" }}</span>

        </p>
       <p class="mb-0">
  <strong>Email:</strong> {{ employee.email|default:"Ch∆∞a c√≥" }}
</p>
<p class="mb-0">
  <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {{ employee.phone_number|default:"-" }}
</p>
      </div>
    </div>
  </div>
</div>


    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card shadow-sm border-left-primary">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                  T·ªïng s·ªë ng√†y
                </div>
                <div class="h4 mb-0 font-weight-bold text-gray-800">{{ stats.total_days }}</div>
                <small class="text-muted">ƒê·∫ßy ƒë·ªß: {{ stats.total_complete_days }}</small>
              </div>
              <div class="col-auto">
                <i class="fas fa-calendar fa-2x text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card shadow-sm border-left-success">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                  T·ªïng gi·ªù l√†m
                </div>
                <div class="h4 mb-0 font-weight-bold text-gray-800">{{ stats.total_work_hours }}h</div>
                <small class="text-muted">TB: {{ stats.avg_work_hours }}h/ng√†y</small>
              </div>
              <div class="col-auto">
                <i class="fas fa-clock fa-2x text-success"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card shadow-sm border-left-warning">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                  ƒêi mu·ªôn
                </div>
                <div class="h4 mb-0 font-weight-bold text-gray-800">{{ stats.total_late_count }}</div>
                <small class="text-muted">{{ stats.late_rate }}%</small>
              </div>
              <div class="col-auto">
                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card shadow-sm border-left-info">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                  V·ªÅ s·ªõm
                </div>
                <div class="h4 mb-0 font-weight-bold text-gray-800">{{ stats.total_early_count }}</div>
                <small class="text-muted">{{ stats.early_rate }}%</small>
              </div>
              <div class="col-auto">
                <i class="fas fa-running fa-2x text-info"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- B·ªô l·ªçc t√¨m ki·∫øm -->
    <div class="card mb-3">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">T·ª´ ng√†y</label>
            <input type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" class="form-control"/>
          </div>
          <div class="col-md-3">
            <label class="form-label">ƒê·∫øn ng√†y</label>
            <input type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" class="form-control"/>
          </div>
          <div class="col-md-3">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select name="status" class="form-control">
              <option value="">-- T·∫•t c·∫£ --</option>
              <option value="complete" {% if request.GET.status == "complete" %}selected{% endif %}>ƒê·∫ßy ƒë·ªß</option>
              <option value="checked_in" {% if request.GET.status == "checked_in" %}selected{% endif %}>Ch∆∞a check-out</option>
              <option value="late" {% if request.GET.status == "late" %}selected{% endif %}>ƒêi tr·ªÖ</option>
              <option value="early" {% if request.GET.status == "early" %}selected{% endif %}>V·ªÅ s·ªõm</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> L·ªçc</button>
          </div>
        </form>
      </div>
    </div>

    <!-- B·∫£ng danh s√°ch ch·∫•m c√¥ng -->
    <div class="row">
      <div class="col-sm-12">
        <div class="card card-table">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-center mb-0 datatable">
                <thead class="thead-light">
                  <tr>
                    <th>STT</th>
                    <th>Ng√†y</th>
                    <th>Ca l√†m</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>S·ªë gi·ªù</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>V·ªã tr√≠</th>
                    <th>X√°c th·ª±c</th>
                    <th>Ghi ch√∫</th>
                    <th>Chi ti·∫øt</th>
                  </tr>
                </thead>
                <tbody>
                  {% for record in data %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                      <strong>{{ record.date }}</strong><br>
                      <small class="text-muted">{{ record.day_of_week }}</small>
                    </td>
                    <td>
                      <strong>{{ record.shift }}</strong><br>
                      <small class="text-muted">{{ record.shift_time }}</small>
                    </td>
                    <td>
                      {% if record.check_in != '-' %}
                        <span class="badge bg-success">{{ record.check_in }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if record.check_out != '-' %}
                        <span class="badge bg-info">{{ record.check_out }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if record.hours %}
                        <strong>{{ record.hours }}h</strong>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if "tr·ªÖ" in record.status or "mu·ªôn" in record.status %}
                        <span class="badge bg-danger">{{ record.status }}</span>
                      {% elif "s·ªõm" in record.status %}
                        <span class="badge bg-warning">{{ record.status }}</span>
                      {% elif "Ch∆∞a" in record.status %}
                        <span class="badge bg-secondary">{{ record.status }}</span>
                      {% else %}
                        <span class="badge bg-success">{{ record.status }}</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <small>{{ record.location }}</small>
                      {% if record.distance != "-" %}
                        <span class="badge {% if 'Sai' in record.location_status %}bg-danger{% else %}bg-success{% endif %} badge-sm">
                          {{ record.distance }}
                        </span>
                      {% endif %}
                    </td>
                    <td class="text-center">
  {% if record.face_image %}
    <img src="{{ record.face_image }}" 
         alt="Face" 
         class="rounded" 
         style="width:40px; height:40px; object-fit:cover;">
  {% else %}
    -
  {% endif %}
</td>

                    <td>
                      <small>{{ record.note|default:"-" }}</small>
                    </td>
                    <td class="text-center">
                      <button type="button" 
                              class="btn btn-sm btn-outline-primary view-detail" 
                              data-id="{{ record.id }}"
                              data-date="{{ record.date }}"
                              data-shift="{{ record.shift }}"
                              data-shift-time="{{ record.shift_time }}"
                              data-checkin="{{ record.check_in }}"
                              data-checkout="{{ record.check_out }}"
                              data-hours="{{ record.hours }}"
                              data-status="{{ record.status }}"
                              data-location="{{ record.location }}"
                              data-distance="{{ record.distance }}"
                              data-face="{{ record.face_verified }}"
                              data-method="{{ record.method }}"
                              data-note="{{ record.note }}"
                              data-image="{{ record.face_image }}">
                        <i class="fas fa-eye"></i>
                      </button>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                      <i class="fas fa-inbox fa-3x mb-2"></i><br>
                      Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng trong kho·∫£ng th·ªùi gian n√†y
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Th·ªëng k√™ theo tu·∫ßn -->
    {% if weekly_stats %}
    <div class="row mt-3">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">üìä Th·ªëng k√™ theo tu·∫ßn</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Tu·∫ßn</th>
                    <th class="text-center">S·ªë ng√†y</th>
                    <th class="text-center">T·ªïng gi·ªù</th>
                    <th class="text-center">Trung b√¨nh</th>
                  </tr>
                </thead>
                <tbody>
                  {% for week in weekly_stats %}
                  <tr>
                    <td>{{ week.week }}</td>
                    <td class="text-center">{{ week.days }}</td>
                    <td class="text-center"><strong>{{ week.hours }}h</strong></td>
                    <td class="text-center">{{ week.avg }}h</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  </div>

  <!-- Modal Chi ti·∫øt -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-primary text-white border-0">
        <h5 class="modal-title d-flex align-items-center" id="detailModalLabel">
          <i class="fas fa-clipboard-check me-2"></i>
          Chi ti·∫øt ch·∫•m c√¥ng
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body p-0" id="detailContent">
        <!-- N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
      </div>
      
      <div class="modal-footer bg-light border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> ƒê√≥ng
        </button>
      </div>
    </div>
  </div>
</div>

  <footer class="text-center py-3">
    <p class="mb-0">B·∫£n quy·ªÅn ¬© ƒê√° Cu·ªôi</p>
  </footer>
</div>

<!-- CSS Custom -->
<style>
.border-left-primary {
  border-left: 4px solid #4e73df !important;
}
.border-left-success {
  border-left: 4px solid #1cc88a !important;
}
.border-left-warning {
  border-left: 4px solid #f6c23e !important;
}
.border-left-info {
  border-left: 4px solid #36b9cc !important;
}
.badge-sm {
  font-size: 0.7rem;
  padding: 0.2rem 0.4rem;
}
</style>

<!-- JS -->
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'assets/js/popper.min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'assets/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables/datatables.min.js' %}"></script>
<script src="{% static 'assets/js/script.js' %}"></script>

<script>
$(document).ready(function () {
  // Xem chi ti·∫øt ch·∫•m c√¥ng
  $(".view-detail").on("click", function () {
    let data = $(this).data();
    
    let html = `
      <div class="container-fluid p-4">
        <!-- Th√¥ng tin ng√†y v√† ca l√†m -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="icon-box bg-primary text-white rounded-circle me-3" style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-calendar-day fa-lg"></i>
                  </div>
                  <div>
                    <small class="text-muted d-block">Ng√†y l√†m vi·ªác</small>
                    <h6 class="mb-0 fw-bold">${data.date}</h6>
                    <small class="text-muted">${data.dayOfWeek || ''}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="icon-box bg-info text-white rounded-circle me-3" style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-clock fa-lg"></i>
                  </div>
                  <div>
                    <small class="text-muted d-block">Ca l√†m vi·ªác</small>
                    <h6 class="mb-0 fw-bold">${data.shift}</h6>
                    <small class="text-muted">${data.shiftTime}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Check-in v√† Check-out -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="icon-box bg-success text-white rounded-circle me-3" style="width:55px;height:55px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-sign-in-alt fa-lg"></i>
                  </div>
                  <div>
                    <small class="text-muted d-block mb-1">Gi·ªù v√†o</small>
                    <h4 class="mb-0 text-success fw-bold">${data.checkin || '<span class="text-muted">--:--</span>'}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="icon-box bg-danger text-white rounded-circle me-3" style="width:55px;height:55px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-sign-out-alt fa-lg"></i>
                  </div>
                  <div>
                    <small class="text-muted d-block mb-1">Gi·ªù ra</small>
                    <h4 class="mb-0 text-danger fw-bold">${data.checkout || '<span class="text-muted">--:--</span>'}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Th√¥ng tin chi ti·∫øt -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0 py-3">
            <h6 class="mb-0 fw-bold">
              <i class="fas fa-info-circle text-primary me-2"></i>Th√¥ng tin chi ti·∫øt
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="detail-item">
                  <i class="fas fa-hourglass-half text-warning me-2"></i>
                  <small class="text-muted d-block">S·ªë gi·ªù l√†m vi·ªác</small>
                  <strong class="text-primary">${data.hours || '0'} gi·ªù</strong>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="detail-item">
                  <i class="fas fa-info-circle text-info me-2"></i>
                  <small class="text-muted d-block">Tr·∫°ng th√°i</small>
                  <strong>${data.status}</strong>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="detail-item">
                  <i class="fas fa-user-check text-success me-2"></i>
                  <small class="text-muted d-block">X√°c th·ª±c khu√¥n m·∫∑t</small>
                  <strong>
                    ${data.face === 'True' || data.face === true 
                      ? '<span class="text-success"><i class="fas fa-check-circle"></i> ƒê√£ x√°c th·ª±c</span>' 
                      : '<span class="text-danger"><i class="fas fa-times-circle"></i> Ch∆∞a x√°c th·ª±c</span>'
                    }
                  </strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- V·ªã tr√≠ v√† ph∆∞∆°ng th·ª©c -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <h6 class="mb-2">
                  <i class="fas fa-map-marker-alt text-danger me-2"></i>V·ªã tr√≠ ch·∫•m c√¥ng
                </h6>
                <p class="mb-1 text-dark">${data.location || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                <small class="text-muted">
                  <i class="fas fa-ruler me-1"></i>Kho·∫£ng c√°ch: 
                  <strong>${data.distance || 'N/A'}</strong>
                </small>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card border-0 bg-light h-100">
              <div class="card-body">
                <h6 class="mb-2">
                  <i class="fas fa-cogs text-secondary me-2"></i>Ph∆∞∆°ng th·ª©c
                </h6>
                <p class="mb-0 text-dark">${data.method || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
              </div>
            </div>
          </div>
        </div>

        ${data.note && data.note !== 'None' && data.note !== '-' ? `
        <!-- Ghi ch√∫ -->
        <div class="card border-0 bg-warning bg-opacity-10 mb-4">
          <div class="card-body">
            <h6 class="mb-2">
              <i class="fas fa-sticky-note text-warning me-2"></i>Ghi ch√∫
            </h6>
            <p class="mb-0">${data.note}</p>
          </div>
        </div>
        ` : ''}

        ${data.image && data.image !== 'None' ? `
        <!-- ·∫¢nh ch·∫•m c√¥ng -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-0 py-3">
            <h6 class="mb-0 fw-bold">
              <i class="fas fa-camera text-primary me-2"></i>·∫¢nh x√°c th·ª±c
            </h6>
          </div>
          <div class="card-body text-center">
            <img src="${data.image}" 
                 alt="·∫¢nh ch·∫•m c√¥ng" 
                 class="img-fluid rounded shadow" 
                 style="max-width:350px; max-height:350px; object-fit:cover;">
          </div>
        </div>
        ` : ''}
      </div>
    `;
    
    $("#detailContent").html(html);
    $("#detailModal").modal("show");
  });
});
</script>

<style>
.bg-gradient-primary {
  background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
}

.icon-box {
  flex-shrink: 0;
}

.detail-item {
  padding: 10px 0;
}

.detail-item i {
  font-size: 1.1rem;
}

.modal-content {
  border-radius: 15px;
  overflow: hidden;
}

.modal-header {
  padding: 1.25rem 1.5rem;
}

.card {
  transition: transform 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
}
</style>

{% endblock %}