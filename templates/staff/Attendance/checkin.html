{% extends 'Home/base.html' %} {% load static %} {% block body %}
<div class="page-wrapper">
  <div class="content container-fluid">
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="page-title">Ch·∫•m c√¥ng</h3>
          <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Ch·∫•m c√¥ng</a></li>
            <li class="breadcrumb-item active">Check-in</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-body">
            <h4 class="mb-3 text-primary">
              Check-in cho <b>{{ attendance.employee }}</b>
              <br />
              <small class="text-muted">Ca: {{ shift.name }}</small>
            </h4>

            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="row">
                <!-- Camera -->
                <div class="col-md-6 text-center mb-3">
                  <label class="form-label">Ch·ª•p ·∫£nh khu√¥n m·∫∑t</label>
                  <div class="camera-box border rounded p-2">
                    <video
                      id="video"
                      width="320"
                      height="240"
                      autoplay
                      style="display: none"
                    ></video>
                    <canvas
                      id="canvas"
                      width="320"
                      height="240"
                      style="display: none"
                    ></canvas>
                  </div>
                  <input type="file" name="face_image" id="face_image" hidden />
                  <div class="mt-2">
                    <button
                      type="button"
                      id="startCamera"
                      class="btn btn-primary btn-sm"
                    >
                      üé• M·ªü camera
                    </button>
                    <button
                      type="button"
                      id="capture"
                      class="btn btn-warning btn-sm"
                      disabled
                    >
                      üì∏ Ch·ª•p ·∫£nh
                    </button>
                  </div>
                </div>

                <!-- GPS -->
                <input type="hidden" name="latitude" id="latitude" />
                <input type="hidden" name="longitude" id="longitude" />

                <!-- Submit -->
                <div class="col-12 text-center mt-4">
                  <button type="submit" class="btn btn-success btn-lg">
                    ‚úÖ X√°c nh·∫≠n Check-in
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // === GPS ===
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        document.getElementById("latitude").value = pos.coords.latitude;
        document.getElementById("longitude").value = pos.coords.longitude;
      },
      function (err) {
        alert("‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message);
      }
    );
  }

  // === Camera ===
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const startBtn = document.getElementById("startCamera");
  const captureBtn = document.getElementById("capture");
  const faceInput = document.getElementById("face_image");
  let stream = null;

  // M·ªü camera khi b·∫•m n√∫t
  startBtn.addEventListener("click", async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      await video.play(); // ƒë·∫£m b·∫£o video ch·∫°y
      video.style.display = "block";
      captureBtn.disabled = false;
      alert("‚úÖ Camera ƒë√£ b·∫≠t, b·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh!");
    } catch (err) {
      console.error("Camera error:", err);
      alert("‚ö†Ô∏è Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c camera: " + err.message);
    }
  });

  // Ch·ª•p ·∫£nh
  captureBtn.addEventListener("click", () => {
    if (!stream) {
      alert("‚ö†Ô∏è B·∫°n ch∆∞a m·ªü camera!");
      return;
    }
    const context = canvas.getContext("2d");
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob((blob) => {
      const file = new File([blob], "face.png", { type: "image/png" });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      faceInput.files = dataTransfer.files;
    });
    alert("üì∑ ƒê√£ ch·ª•p ·∫£nh khu√¥n m·∫∑t!");
  });
</script>
{% endblock %}
