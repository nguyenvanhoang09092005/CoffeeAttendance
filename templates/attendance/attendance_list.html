{% extends 'Home/base.html' %}
{% load static %}

{% block body %}
<div class="page-wrapper">
  <div class="content container-fluid">

    <!-- Header -->
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="page-title text-primary">üìã Qu·∫£n l√Ω ch·∫•m c√¥ng</h3>
          <ul class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'admin_dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">Ch·∫•m c√¥ng</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- B·ªô l·ªçc t√¨m ki·∫øm -->
    <div class="card mb-3">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-2">
            <label class="form-label">T·ª´ ng√†y</label>
            <input type="date" name="start_date" value="{{ start_date }}" class="form-control"/>
          </div>
          <div class="col-md-2">
            <label class="form-label">ƒê·∫øn ng√†y</label>
            <input type="date" name="end_date" value="{{ end_date }}" class="form-control"/>
          </div>
          <div class="col-md-2">
            <label class="form-label">Nh√¢n vi√™n</label>
            <input type="text" name="employee" placeholder="T√™n ho·∫∑c M√£ NV" value="{{ request.GET.employee }}" class="form-control"/>
          </div>
          <div class="col-md-2">
            <label class="form-label">Ca l√†m</label>
            <select name="shift" class="form-control">
              <option value="">-- T·∫•t c·∫£ --</option>
              {% for shift in shifts %}
              <option value="{{ shift.id }}" {% if request.GET.shift == shift.id|stringformat:'s' %}selected{% endif %}>
                {{ shift.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select name="status" class="form-control">
              <option value="">-- T·∫•t c·∫£ --</option>
              <option value="checked_in" {% if request.GET.status == "checked_in" %}selected{% endif %}>ƒê√£ check-in</option>
              <option value="checked_out" {% if request.GET.status == "checked_out" %}selected{% endif %}>ƒê√£ check-out</option>
              <option value="late" {% if request.GET.status == "late" %}selected{% endif %}>ƒêi tr·ªÖ</option>
              <option value="early" {% if request.GET.status == "early" %}selected{% endif %}>V·ªÅ s·ªõm</option>
              <option value="not_checked" {% if request.GET.status == "not_checked" %}selected{% endif %}>Ch∆∞a check-in/out</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> L·ªçc</button>
          </div>
        </form>
      </div>
    </div>

    <!-- B·∫£ng danh s√°ch ch·∫•m c√¥ng -->
    <div class="row">
      <div class="col-sm-12">
        <div class="card card-table">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-center mb-0 datatable">
                <thead class="thead-light">
                  <tr>
                    <th>STT</th>
                    <th>Nh√¢n vi√™n</th>
                    <th>M√£ NV</th>
                    <th>Ca</th>
                    <th>Ng√†y</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>Gi·ªù l√†m</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ghi ch√∫</th>
                    <th>·∫¢nh</th>
                    <th>GPS</th>
                    <th>Ph∆∞∆°ng th·ª©c</th>
                  </tr>
                </thead>
                <tbody>
  {% for row in data %}
  <tr>
    <td>{{ row.stt }}</td>
    <td>
      <a href="javascript:void(0);" 
         class="text-primary fw-bold employee-history" 
         data-id="{{ row.employee_id }}">
        {{ row.employee_name }}
      </a>
    </td>
    <td>{{ row.employee_id }}</td>
    <td>{{ row.shift }}</td>
    <td>{{ row.date }}</td>
    <td>{{ row.check_in }}</td>
    <td>{{ row.check_out }}</td>
    <td>{{ row.hours }}</td>
    <td>
      {% if "tr·ªÖ" in row.status %}
        <span class="badge bg-danger">{{ row.status }}</span>
      {% elif "s·ªõm" in row.status %}
        <span class="badge bg-warning">{{ row.status }}</span>
      {% elif "Ch∆∞a" in row.status %}
        <span class="badge bg-secondary">{{ row.status }}</span>
      {% else %}
        <span class="badge bg-success">{{ row.status }}</span>
      {% endif %}
    </td>
    <td>{{ row.note|default:"-" }}</td>
    <td>
      {% if row.face_image %}
        <img src="{{ row.face_image }}" alt="Face" class="rounded" style="width:40px; height:40px; object-fit:cover;">
      {% else %}
        -
      {% endif %}
    </td>
    <td>{{ row.gps }}</td>
    <td>{{ row.method }}</td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="13" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</td>
  </tr>
  {% endfor %}
</tbody>

              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal L·ªãch s·ª≠ ch·∫•m c√¥ng -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="historyModalLabel">üìå L·ªãch s·ª≠ ch·∫•m c√¥ng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="historyContent">
        <p class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>
    </div>
  </div>
</div>


  <footer class="text-center py-3">
    <p class="mb-0">B·∫£n quy·ªÅn ¬© ƒê√° Cu·ªôi</p>
  </footer>
</div>

<!-- JS -->
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'assets/js/popper.min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'assets/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables/datatables.min.js' %}"></script>
<script src="{% static 'assets/js/script.js' %}"></script>
<script>
$(document).ready(function () {
  $(".employee-history").on("click", function () {
    let empId = $(this).data("id");

    // Hi·ªán modal NGAY l·∫≠p t·ª©c v·ªõi th√¥ng b√°o ch·ªù
    $("#historyContent").html('<p class="text-center text-muted">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>');
    $("#historyModal").modal("show");

    // Sau ƒë√≥ g·ªçi API load d·ªØ li·ªáu
    $.get(`/attendance/history/${empId}/`, function (data) {
      if (data.length === 0) {
        $("#historyContent").html('<p class="text-center text-muted">Kh√¥ng c√≥ l·ªãch s·ª≠ ch·∫•m c√¥ng</p>');
        return;
      }

      let html = `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-light">
              <tr>
                <th>Ca</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>ƒê·ªãa ƒëi·ªÉm</th>
                <th>Kho·∫£ng c√°ch</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
                <th>Ng√†y t·∫°o</th>
              </tr>
            </thead>
            <tbody>
      `;

      data.forEach(function (row) {
        html += `
          <tr>
            <td>${row.shift || "--"}</td>
            <td>${row.check_in_time || "-"}</td>
            <td>${row.check_out_time || "-"}</td>
            <td>${row.location_note || "-"}</td>
            <td>${row.distance || "-"}</td>
            <td>
              ${row.status 
                ? `<span class="badge ${row.status.includes("tr·ªÖ") ? "bg-danger" : row.status.includes("s·ªõm") ? "bg-warning" : "bg-success"}">${row.status}</span>` 
                : "-"
              }
            </td>
            <td>${row.note || "-"}</td>
            <td>${row.created_at || "-"}</td>
          </tr>
        `;
      });

      html += "</tbody></table></div>";
      $("#historyContent").html(html);
    })
    .fail(function () {
      $("#historyContent").html('<p class="text-danger text-center">‚ö†Ô∏è L·ªói khi t·∫£i d·ªØ li·ªáu!</p>');
    });
  });
});
</script>

{% endblock %}
