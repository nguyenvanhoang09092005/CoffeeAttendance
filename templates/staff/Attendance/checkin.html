{% extends 'staff/Dashboard/base.html' %} {% load static %} {% block body %}
<div class="page-wrapper">
  <div class="content container-fluid">
    <!-- Header -->
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="page-title text-primary">📋 Chấm công</h3>
          <ul class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'attendance:attendance_list' %}">Chấm công</a>
            </li>
            <li class="breadcrumb-item active">Check-in</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12">
        <div class="card shadow-lg border-0 rounded-4">
          <div class="card-body">
            <!-- Đã check-out -->
            {% if attendance.check_out_time %}
            <div class="text-center py-5">
              <i
                class="bi bi-emoji-smile-fill text-primary mb-3"
                style="font-size: 4rem"
              ></i>
              <h3 class="text-primary fw-bold">
                🎉 Bạn đã hoàn tất ca hôm nay!
              </h3>
              <p class="text-muted">
                Check-in:
                <b>{{ attendance.check_in_time|date:"H:i:s d/m/Y" }}</b>
              </p>
              <p class="text-muted">
                Check-out:
                <b>{{ attendance.check_out_time|date:"H:i:s d/m/Y" }}</b>
              </p>
              {% if attendance.face_image %}
              <img
                src="{{ attendance.face_image.url }}"
                class="rounded border shadow-sm mt-3"
                style="max-width: 320px; aspect-ratio: 4/3; object-fit: cover"
              />
              {% endif %}
            </div>

            <!-- Đã check-in nhưng chưa check-out -->
            {% elif attendance.check_in_time %}
            <div class="mb-4">
              <h4 class="fw-bold text-dark mb-1">
                👤 Nhân viên:
                <span class="text-success">{{ attendance.employee }}</span>
              </h4>
              <p class="text-muted mb-0">🕑 Ca làm: <b>{{ shift.name }}</b></p>
              <p class="text-muted">
                Check-in lúc:
                <b>{{ attendance.check_in_time|date:"H:i:s d/m/Y" }}</b>
              </p>
            </div>

            <form method="post" enctype="multipart/form-data" id="checkoutForm">
              {% csrf_token %}
              <div class="row g-4">
                <!-- Camera -->
                <div class="col-md-6 text-center">
                  <label class="form-label fw-bold fs-6">🎥 Camera</label>
                  <div class="border rounded p-3 bg-light position-relative">
                    <video
                      id="video"
                      autoplay
                      playsinline
                      muted
                      class="rounded-3 border shadow-sm w-100"
                      style="aspect-ratio: 4/3; object-fit: cover"
                    ></video>
                    <canvas id="canvas" class="d-none"></canvas>
                    <img
                      id="preview"
                      class="rounded-3 border shadow-sm d-none mt-3"
                      style="
                        aspect-ratio: 4/3;
                        max-width: 100%;
                        object-fit: cover;
                      "
                    />
                    <p id="camera-status" class="text-muted mt-2 small">
                      👉 Nhấn "Mở camera" để bắt đầu
                    </p>
                  </div>
                  <input
                    type="file"
                    name="face_image"
                    id="face_image"
                    style="display: none"
                  />
                  <div class="mt-3 d-flex justify-content-center gap-2">
                    <button
                      type="button"
                      id="startCamera"
                      class="btn btn-outline-primary"
                    >
                      🎥 Mở camera
                    </button>
                    <button
                      type="button"
                      id="capture"
                      class="btn btn-outline-success"
                      disabled
                    >
                      📸 Chụp ảnh
                    </button>
                  </div>
                </div>

                <!-- GPS -->
                <div class="col-md-6">
                  <label class="form-label fw-bold fs-6">📍 Vị trí</label>
                  <div class="p-3 border rounded bg-light">
                    <p class="mb-1">
                      🌍 Vĩ độ: <span id="latText" class="fw-bold">--</span>
                    </p>
                    <p class="mb-0">
                      🌍 Kinh độ: <span id="lonText" class="fw-bold">--</span>
                    </p>
                  </div>
                </div>

                <!-- Hidden inputs -->
                <input type="hidden" name="action" value="checkout" />
                <input type="hidden" name="latitude" id="latitude" />
                <input type="hidden" name="longitude" id="longitude" />
                <input type="hidden" name="location_note" id="location_note" />

                <!-- Submit -->
                <div class="col-12 text-center">
                  <button type="submit" class="btn btn-danger btn-lg px-5">
                    🔚 Xác nhận Check-out
                  </button>
                </div>
              </div>
            </form>

            <div class="alert alert-info mt-4">
              <b>Lưu ý:</b> Khi check-out cũng phải chụp ảnh và bật GPS. Nếu
              không trùng khớp sẽ báo lỗi.
            </div>

            <!-- Chưa check-in -->
            {% else %}
            <div class="mb-4">
              <h4 class="fw-bold text-dark mb-1">
                👤 Nhân viên:
                <span class="text-success">{{ attendance.employee }}</span>
              </h4>
              <p class="text-muted mb-0">🕑 Ca làm: <b>{{ shift.name }}</b></p>
            </div>

            <form method="post" enctype="multipart/form-data" id="checkinForm">
              {% csrf_token %}
              <div class="row g-4">
                <!-- Camera -->
                <div class="col-md-6 text-center">
                  <label class="form-label fw-bold fs-6">🎥 Camera</label>
                  <div class="border rounded p-3 bg-light position-relative">
                    <video
                      id="video"
                      autoplay
                      playsinline
                      muted
                      class="rounded-3 border shadow-sm w-100"
                      style="aspect-ratio: 4/3; object-fit: cover"
                    ></video>
                    <canvas id="canvas" class="d-none"></canvas>
                    <img
                      id="preview"
                      class="rounded-3 border shadow-sm d-none mt-3"
                      style="
                        aspect-ratio: 4/3;
                        max-width: 100%;
                        object-fit: cover;
                      "
                    />
                    <p id="camera-status" class="text-muted mt-2 small">
                      👉 Nhấn "Mở camera" để bắt đầu
                    </p>
                  </div>
                  <input
                    type="file"
                    name="face_image"
                    id="face_image"
                    style="display: none"
                  />
                  <div class="mt-3 d-flex justify-content-center gap-2">
                    <button
                      type="button"
                      id="startCamera"
                      class="btn btn-outline-primary"
                    >
                      🎥 Mở camera
                    </button>
                    <button
                      type="button"
                      id="capture"
                      class="btn btn-outline-success"
                      disabled
                    >
                      📸 Chụp ảnh
                    </button>
                  </div>
                </div>

                <!-- GPS -->
                <div class="col-md-6">
                  <label class="form-label fw-bold fs-6">📍 Vị trí</label>
                  <div class="p-3 border rounded bg-light">
                    <p class="mb-1">
                      🌍 Vĩ độ: <span id="latText" class="fw-bold">--</span>
                    </p>
                    <p class="mb-0">
                      🌍 Kinh độ: <span id="lonText" class="fw-bold">--</span>
                    </p>
                  </div>
                </div>

                <!-- Hidden inputs -->
                <input type="hidden" name="action" value="checkin" />
                <input type="hidden" name="latitude" id="latitude" />
                <input type="hidden" name="longitude" id="longitude" />
                <input type="hidden" name="location_note" id="location_note" />

                <!-- Submit -->
                <div class="col-12 text-center">
                  <button type="submit" class="btn btn-success btn-lg px-5">
                    ✅ Xác nhận Check-in
                  </button>
                </div>
              </div>
            </form>

            <div class="alert alert-info mt-4">
              <b>Lưu ý:</b> Đứng nơi đủ sáng, giữ khuôn mặt rõ, bật GPS để hệ
              thống xác thực.
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if not attendance.check_out_time %}
<script>
  const mapboxToken =
    "pk.eyJ1IjoiaG9hbmdrZTM0MDJmIiwiYSI6ImNtYTBkYzAyZzIyeWsyam13dTFjOWthMHUifQ.lXQX_tarAl9h2Vqhx5Gg5Q";

  // === GPS ===
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lon.toFixed(6);
        document.getElementById("latText").innerText = lat.toFixed(6);
        document.getElementById("lonText").innerText = lon.toFixed(6);
        getAddress(lat, lon);
      },
      (err) => {
        alert("⚠️ Không lấy được GPS: " + err.message);
      }
    );
  }

  // === Camera ===
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const startBtn = document.getElementById("startCamera");
  const captureBtn = document.getElementById("capture");
  const faceInput = document.getElementById("face_image");
  const cameraStatus = document.getElementById("camera-status");
  const preview = document.getElementById("preview");
  let stream = null;

  startBtn.addEventListener("click", async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
      });
      video.srcObject = stream;
      await video.play();
      captureBtn.disabled = false;
      cameraStatus.innerText = "✅ Camera đã bật, sẵn sàng chụp!";
      startBtn.innerText = "🔄 Chụp lại";
      preview.classList.add("d-none");
    } catch (err) {
      alert("⚠️ Không truy cập được camera: " + err.message);
    }
  });

  captureBtn.addEventListener("click", () => {
    if (!stream) {
      alert("⚠️ Bạn chưa mở camera!");
      return;
    }
    const context = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob((blob) => {
      const file = new File([blob], "face.png", { type: "image/png" });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      faceInput.files = dataTransfer.files;
      preview.src = URL.createObjectURL(blob);
      preview.classList.remove("d-none");
      cameraStatus.innerText = "📷 Ảnh đã được chụp!";
    });
  });

  // === Địa chỉ từ Mapbox ===
  function getAddress(lat, lon) {
    fetch(
      `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?access_token=${mapboxToken}&language=vi`
    )
      .then((res) => res.json())
      .then((data) => {
        if (data.features && data.features.length > 0) {
          const address = data.features[0].place_name;
          document.getElementById("location_note").value = address;
        }
      })
      .catch((err) => console.error(err));
  }

  // === Validate ===
  function validateForm(e) {
    if (!faceInput.files.length) {
      e.preventDefault();
      alert("❌ Bạn phải chụp ảnh khuôn mặt trước khi gửi!");
    }
    if (
      !document.getElementById("latitude").value ||
      !document.getElementById("longitude").value
    ) {
      e.preventDefault();
      alert("❌ Không lấy được vị trí GPS!");
    }
  }
  document
    .getElementById("checkinForm")
    ?.addEventListener("submit", validateForm);
  document
    .getElementById("checkoutForm")
    ?.addEventListener("submit", validateForm);
</script>
{% endif %} {% endblock %}
