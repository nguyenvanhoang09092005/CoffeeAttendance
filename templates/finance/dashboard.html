{% extends 'Home/base.html' %}
{% load static %}
{% load humanize %}
{% block body %}

<style>
  .stat-card {
    border-radius: 10px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .chart-container {
    position: relative;
    height: 300px;
  }

  .activity-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 3px solid;
    background: #f8f9fa;
    transition: background 0.3s ease;
  }

  .activity-item:hover {
    background: #e9ecef;
  }

  .badge-lg {
    padding: 8px 12px;
    font-size: 14px;
  }

  
</style>

<div class="page-wrapper">
  <div class="content container-fluid">
    <!-- Page Header -->
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="page-title">Tổng quan tài chính</h3>
          <ul class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'admin_dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">Tài chính</li>
          </ul>
        </div>
        <div class="col-auto">
          <div class="btn-group">
            <a href="{% url 'finance:revenue_create' %}" class="btn btn-success">
              <i class="fas fa-plus"></i> Thêm doanh thu
            </a>
            <a href="{% url 'finance:expense_create' %}" class="btn btn-warning">
              <i class="fas fa-plus"></i> Thêm chi phí
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Thống kê tổng quan -->
    <div class="row">
      <!-- Tổng doanh thu -->
      <div class="col-xl-3 col-sm-6 col-12 mb-4">
        <div class="card stat-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Tổng doanh thu</h6>
                <h3 class="mb-0 text-success">{{ total_revenue|floatformat:0|intcomma }}</h3>
                <small class="text-muted">VND</small>
              </div>
              <div class="stat-icon bg-success-light text-success">
                <i class="fas fa-arrow-up"></i>
              </div>
            </div>
            <div class="mt-3">
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-calendar-alt"></i> Tháng này: 
                <strong class="text-success">{{ revenue_this_month|floatformat:0|intcomma }} VND</strong>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Tổng chi phí -->
      <div class="col-xl-3 col-sm-6 col-12 mb-4">
        <div class="card stat-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Tổng chi phí</h6>
                <h3 class="mb-0 text-danger">{{ total_expense|floatformat:0|intcomma }}</h3>
                <small class="text-muted">VND</small>
              </div>
              <div class="stat-icon bg-danger-light text-danger">
                <i class="fas fa-arrow-down"></i>
              </div>
            </div>
            <div class="mt-3">
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-calendar-alt"></i> Tháng này: 
                <strong class="text-danger">{{ expense_this_month|floatformat:0|intcomma }} VND</strong>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Lợi nhuận -->
      <div class="col-xl-3 col-sm-6 col-12 mb-4">
        <div class="card stat-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Lợi nhuận</h6>
                <h3 class="mb-0 {% if profit >= 0 %}text-primary{% else %}text-danger{% endif %}">
                  {{ profit|floatformat:0|intcomma }}
                </h3>
                <small class="text-muted">VND</small>
              </div>
              <div class="stat-icon {% if profit >= 0 %}bg-primary-light text-primary{% else %}bg-danger-light text-danger{% endif %}">
                <i class="fas fa-chart-line"></i>
              </div>
            </div>
            <div class="mt-3">
              <div class="progress" style="height: 6px;">
                <div class="progress-bar {% if profit >= 0 %}bg-primary{% else %}bg-danger{% endif %}" 
                     role="progressbar" style="width: 100%"></div>
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-calendar-alt"></i> Tháng này: 
                <strong class="{% if profit_this_month >= 0 %}text-primary{% else %}text-danger{% endif %}">
                  {{ profit_this_month|floatformat:0|intcomma }} VND
                </strong>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Bảng lương chờ duyệt -->
      <div class="col-xl-3 col-sm-6 col-12 mb-4">
        <div class="card stat-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">BL chờ duyệt</h6>
                <h3 class="mb-0 text-warning">{{ pending_payrolls }}</h3>
                <small class="text-muted">Phiếu</small>
              </div>
              <div class="stat-icon bg-warning-light text-warning">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            <div class="mt-3">
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 100%"></div>
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-exclamation-circle"></i> 
                {% if pending_payrolls > 0 %}
                <strong class="text-warning">Cần xử lý ngay</strong>
                {% else %}
                <strong class="text-success">Đã xử lý hết</strong>
                {% endif %}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Biểu đồ -->
    <div class="row">
      <!-- Biểu đồ doanh thu & chi phí -->
      <div class="col-lg-8 col-md-12 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <div class="row align-items-center">
              <div class="col">
                <h5 class="card-title mb-0">
                  <i class="fas fa-chart-bar text-primary"></i> Doanh thu & Chi phí
                </h5>
              </div>
              <div class="col-auto">
                <select class="form-select form-select-sm" id="chartPeriod">
                  <option value="7">7 ngày qua</option>
                  <option value="30" selected>30 ngày qua</option>
                  <option value="90">90 ngày qua</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="revenueExpenseChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Biểu đồ tròn phân bổ -->
<div class="col-lg-4 col-md-12 mb-4">
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h5 class="card-title mb-0">
        <i class="fas fa-chart-pie text-success"></i> Phân bổ chi phí
      </h5>
    </div>
    <div class="card-body">
      <div class="chart-container">
        <canvas id="expensePieChart"></canvas>
      </div>
      {% comment %} <div class="mt-3 text-center">
        <span class="badge badge-lg bg-danger-light text-danger">
          Độc lập: {{ standalone_expense|floatformat:0|intcomma }} VND
        </span>
        <span class="badge badge-lg bg-warning-light text-warning ml-2">
          Doanh thu: {{ revenue_expense|floatformat:0|intcomma }} VND
        </span>
        <span class="badge badge-lg bg-primary-light text-primary ml-2">
          Lương: {{ payroll_expense|floatformat:0|intcomma }} VND
        </span>
      </div> {% endcomment %}
    </div>
  </div>
</div>

    <!-- Hoạt động gần đây -->
    <div class="row">
      <!-- Chi phí gần đây (GỘP) -->
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-danger text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-minus-circle"></i> Chi phí gần đây</h5>
              <a href="{% url 'finance:expense_list' %}" class="btn btn-sm btn-light">
                Xem tất cả <i class="fas fa-arrow-right"></i>
              </a>
            </div>
          </div>
          <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            {% for expense in recent_expenses %}
            <div class="activity-item border-danger">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  {% if expense.is_standalone %}
                  <a href="{% url 'finance:expense_detail' expense.pk %}" class="text-dark font-weight-bold">
                    {{ expense.category.name|default:"Khác" }}
                  </a>
                  <p class="mb-1 small text-muted">{{ expense.description|truncatewords:8 }}</p>
                  <small class="text-muted">
                    <i class="fas fa-calendar"></i> {{ expense.expense_date|date:"d/m/Y" }}
                    • <span class="badge badge-sm badge-secondary">Độc lập</span>
                  </small>
                  {% else %}
                  <a href="{% url 'finance:revenue_detail' expense.revenue.pk %}" class="text-dark font-weight-bold">
                    {{ expense.category.name|default:"Khác" }}
                  </a>
                  <p class="mb-1 small text-muted">{{ expense.description|truncatewords:8 }}</p>
                  <small class="text-muted">
                    <i class="fas fa-calendar"></i> {{ expense.expense_date|date:"d/m/Y" }}
                    • <span class="badge badge-sm badge-warning">{{ expense.revenue.get_shift_display }}</span>
                  </small>
                  {% endif %}
                </div>
                <div class="text-right">
                  <span class="badge badge-danger">{{ expense.amount|floatformat:0|intcomma }}</span>
                  {% if expense.is_standalone %}
                  <br>
                  <small class="badge mt-1
                    {% if expense.status == 'pending' %}badge-warning
                    {% elif expense.status == 'approved' %}badge-success
                    {% else %}badge-secondary{% endif %}">
                    {{ expense.get_status_display }}
                  </small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% empty %}
            <p class="text-center text-muted py-3">
              <i class="fas fa-inbox fa-2x mb-2"></i><br>
              Chưa có chi phí nào
            </p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Doanh thu gần đây -->
      <div class="col-lg-6 ol-md-12 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Doanh thu gần đây</h5>
              <a href="{% url 'finance:revenue_list' %}" class="btn btn-sm btn-light">
                Xem tất cả <i class="fas fa-arrow-right"></i>
              </a>
            </div>
          </div>
          <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            {% for revenue in recent_revenues %}
            <div class="activity-item border-success">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <a href="{% url 'finance:revenue_detail' revenue.pk %}" class="text-dark font-weight-bold">
                    {{ revenue.get_shift_display }} - {{ revenue.revenue_date|date:"d/m/Y" }}
                  </a>
                  <p class="mb-1 small">
                    <span class="text-primary">Thu: {{ revenue.tong|floatformat:0|intcomma }}</span> •
                    <span class="text-danger">Chi: {{ revenue.chi|floatformat:0|intcomma }}</span>
                  </p>
                  <small class="text-muted">
                    <i class="fas fa-user"></i> {{ revenue.created_by.first_name|default:revenue.created_by.username }}
                  </small>
                </div>
                <div class="text-right">
                  <span class="badge badge-success">{{ revenue.danh_thu_rong|floatformat:0|intcomma }}</span>
                  <br>
                  <small class="text-muted">Ròng</small>
                </div>
              </div>
            </div>
            {% empty %}
            <p class="text-center text-muted py-3">
              <i class="fas fa-inbox fa-2x mb-2"></i><br>
              Chưa có doanh thu nào
            </p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Bảng lương gần đây -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-wallet"></i> Bảng lương gần đây</h5>
              <a href="{% url 'finance:payroll_list' %}" class="btn btn-sm btn-light">
                Xem tất cả <i class="fas fa-arrow-right"></i>
              </a>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Nhân viên</th>
                    <th>Kỳ lương</th>
                    <th class="text-right">Giờ làm</th>
                    <th class="text-right">Lương/giờ</th>
                    <th class="text-right">Thực nhận</th>
                    <th class="text-center">Trạng thái</th>
                    <th class="text-center">Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payroll in recent_payrolls %}
                  <tr>
                    <td>
                      <strong>{{ payroll.employee.first_name }} {{ payroll.employee.last_name }}</strong>
                    </td>
                    <td>
                      <small>{{ payroll.start_date|date:"d/m" }} - {{ payroll.end_date|date:"d/m/Y" }}</small>
                    </td>
                    <td class="text-right">{{ payroll.total_hours }}h</td>
                    <td class="text-right">{{ payroll.hourly_rate|floatformat:0|intcomma }}</td>
                    <td class="text-right">
                      <strong class="text-primary">{{ payroll.net_salary|floatformat:0|intcomma }} VND</strong>
                    </td>
                    <td class="text-center">
                      <span class="badge
                        {% if payroll.status == 'draft' %}badge-secondary
                        {% elif payroll.status == 'pending' %}badge-warning
                        {% elif payroll.status == 'approved' %}badge-info
                        {% elif payroll.status == 'paid' %}badge-success
                        {% else %}badge-danger{% endif %}">
                        {{ payroll.get_status_display }}
                      </span>
                    </td>
                    <td class="text-center">
                      <a href="{% url 'finance:payroll_detail' payroll.pk %}" 
                         class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i>
                      </a>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      <i class="fas fa-inbox fa-2x mb-2"></i><br>
                      Chưa có bảng lương nào
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>Bản quyền thuộc về Đá Cuội.</p>
  </footer>
</div>

<!-- Scripts -->
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'assets/js/popper.min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'assets/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{% static 'assets/js/script.js' %}"></script>

<script>
  // Biểu đồ doanh thu & chi phí (Line Chart)
  const ctx1 = document.getElementById('revenueExpenseChart').getContext('2d');
  
  // Data mẫu - trong thực tế nên lấy từ backend
  const totalRevenue = {{ revenue_this_month|default:0 }};
  const totalExpense = {{ expense_this_month|default:0 }};
  
  const revenueExpenseChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'],
      datasets: [{
        label: 'Tổng thu',
        data: [
          totalRevenue * 0.2, 
          totalRevenue * 0.25, 
          totalRevenue * 0.28, 
          totalRevenue * 0.27
        ],
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.4,
        fill: true
      }, {
        label: 'Tổng chi',
        data: [
          totalExpense * 0.2, 
          totalExpense * 0.23, 
          totalExpense * 0.27, 
          totalExpense * 0.30
        ],
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        tension: 0.4,
        fill: true
      }, {
        label: 'Lợi nhuận',
        data: [
          totalRevenue * 0.2 - totalExpense * 0.2,
          totalRevenue * 0.25 - totalExpense * 0.23,
          totalRevenue * 0.28 - totalExpense * 0.27,
          totalRevenue * 0.27 - totalExpense * 0.30
        ],
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString('vi-VN') + ' VND';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return Math.round(value).toLocaleString('vi-VN') + ' VND';
            }
          }
        }
      }
    }
  });

  // Biểu đồ tròn phân bổ chi phí
 const ctx2 = document.getElementById('expensePieChart').getContext('2d');
const expensePieChart = new Chart(ctx2, {
  type: 'doughnut',
  data: {
    labels: ['Chi phí độc lập', 'Chi từ doanh thu', 'Tiền lương'],
    datasets: [{
      data: [
        {{ standalone_expense|default:0 }}, 
        {{ revenue_expense|default:0 }},
        {{ payroll_expense|default:0 }}
      ],
      backgroundColor: ['#dc3545', '#ffc107', '#007bff'],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const value = context.parsed;
            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
            return context.label + ': ' + Math.round(value).toLocaleString('vi-VN') + ' VND (' + percentage + '%)';
          }
        }
      }
    }
  }
});
</script>
{% endblock %}